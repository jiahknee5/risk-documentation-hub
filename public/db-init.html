<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Initialization - Risk Documentation Hub</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { background: #0066cc; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #0052a3; }
        .status { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Database Initialization</h1>
        <p>This tool will initialize the database for the Risk Documentation Hub.</p>
        
        <button class="btn" onclick="initializeDatabase()">Initialize Database</button>
        <button class="btn" onclick="testLogin()">Test Login</button>
        
        <div id="status"></div>
        
        <div class="status info">
            <h3>Demo Accounts</h3>
            <ul>
                <li><strong>Admin:</strong> admin@example.com / password123</li>
                <li><strong>Manager:</strong> manager@example.com / password123</li>
                <li><strong>User:</strong> user@example.com / password123</li>
                <li><strong>Viewer:</strong> viewer@example.com / password123</li>
            </ul>
        </div>
    </div>

    <script>
        async function initializeDatabase() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="status info">üîÑ Initializing database...</div>';
            
            try {
                // Try multiple endpoints
                const endpoints = [
                    '/bootstrap',
                    '/api/bootstrap', 
                    '/api/setup',
                    '/api/init-db',
                    '/api/seed-db?secret=setup-risk-docs-2024'
                ];
                
                let success = false;
                let lastError = '';
                
                for (const endpoint of endpoints) {
                    try {
                        statusDiv.innerHTML = `<div class="status info">üîÑ Trying ${endpoint}...</div>`;
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            statusDiv.innerHTML = `
                                <div class="status success">
                                    <h3>‚úÖ Database Initialized Successfully!</h3>
                                    <p>Endpoint: ${endpoint}</p>
                                    <pre>${JSON.stringify(data, null, 2)}</pre>
                                </div>
                            `;
                            success = true;
                            break;
                        } else {
                            const errorData = await response.text();
                            lastError = `${endpoint}: ${response.status} - ${errorData}`;
                        }
                    } catch (err) {
                        lastError = `${endpoint}: ${err.message}`;
                        continue;
                    }
                }
                
                if (!success) {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <h3>‚ùå Database Initialization Failed</h3>
                            <p>All endpoints failed. Last error:</p>
                            <pre>${lastError}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <h3>‚ùå Error</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
        
        async function testLogin() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="status info">üîÑ Testing login...</div>';
            
            try {
                const response = await fetch('/api/auth/callback/credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'email=admin@example.com&password=password123'
                });
                
                if (response.ok || response.status === 302) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            <h3>‚úÖ Login Test Successful!</h3>
                            <p>You should now be able to access:</p>
                            <ul>
                                <li><a href="/dashboard">Dashboard</a></li>
                                <li><a href="/documents">Documents</a></li>
                                <li><a href="/search">Search</a></li>
                                <li><a href="/users">Users</a></li>
                                <li><a href="/audit">Audit</a></li>
                            </ul>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status error">
                            <h3>‚ùå Login Test Failed</h3>
                            <p>Status: ${response.status}</p>
                            <pre>${await response.text()}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        <h3>‚ùå Login Test Error</h3>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>